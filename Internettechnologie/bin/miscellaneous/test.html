

 <html>
 <head>
		<title>TESTSEITE</title>
	</head>
	
    <script type="text/javascript">
    var canvas, ctx, flag = false,
        posX = 0,
        posY = 0,
        done = true,
        lineArray = [],
        username,
        password,
        xmlhttpr;
    
    function init() {
        canvas = document.getElementById('can');
        ctx = canvas.getContext("2d");
        w = canvas.width;
        h = canvas.height;
    
        canvas.addEventListener("mousedown", function (e) {
            processMouseEvent('down', e)
        }, false);
        canvas.addEventListener("mouseup", function (e) {
            processMouseEvent('up', e)
        }, false);
        canvas.addEventListener("mouseout", function (e) {
            processMouseEvent('out', e)
        }, false);
        
        username = document.getElementById("username").value;
    	password = document.getElementById("password").value;
    	
        if(username != "" && password != ""){
        	processLogin();
        }
    }
    
    function processMouseEvent(action, e){
    	if(action == 'up' || action == 'out'){
	    	if(done == false){
	    		ctx.strokeStyle = 'black';
	    		ctx.lineWidth = 2;
	    		ctx.moveTo(posX, posY);
	    		ctx.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
	    		ctx.stroke();
	    		lineArray.push(posX);
	    		lineArray.push(posY);
	    		lineArray.push(e.clientX - canvas.offsetLeft);
	    		lineArray.push(e.clientY - canvas.offsetTop);
	    		console.log(lineArray);
	    		
			    if(window.XMLHttpRequest){
		    		xmlhttpr = new XMLHttpRequest();
		    	}
		    	else if(window.ActiveXObject){
		    		xmlhttpr = new ActiveXObject("Microsoft.XMLHTTP");
		    	}
		    	else{
		    		console.log("Can't create XMLHttpRequestObject");
		    		return false;
		    	}
		    	
		    	if(xmlhttpr){
		    		if(xmlhttpr.readyState==4 || xmlhttpr.readyState==0){
		    			xmlhttpr.open("POST", "/canvas_save", true);
		    			var coords = "{\"x1\":"+posX;
		    			coords = coords+", \"y1\":"+posY;
		    			coords = coords+", \"x2\":"+(e.clientX - canvas.offsetLeft);
		    			coords = coords+", \"y2\":"+(e.clientY - canvas.offsetTop)+"}";
		    			xmlhttpr.send("coords="+coords);
		    		}
		    		else{
		    			console.log("XMLHttpRequestObject not ready, trying again ...");
		    			setTimeout('processLogin()', 1000);
		    		}
		    	}
	    		
	    		done = true;
	    	}
   	 	}
    	else if(action == 'down'){
	    	posX = e.clientX - canvas.offsetLeft;
	    	posY = e.clientY - canvas.offsetTop;
	    	done = false;
    	}
    	
    
    }
    
    function processLogin(){
    	username = document.getElementById("username").value;
    	password = document.getElementById("password").value;
    	
    	if(window.XMLHttpRequest){
    		xmlhttpr = new XMLHttpRequest();
    	}
    	else if(window.ActiveXObject){
    		xmlhttpr = new ActiveXObject("Microsoft.XMLHTTP");
    	}
    	else{
    		console.log("Can't create XMLHttpRequestObject");
    		return false;
    	}
    	
    	if(xmlhttpr){
    		if(xmlhttpr.readyState==4 || xmlhttpr.readyState==0){
    			xmlhttpr.open("POST", "/login", true);
    			xmlhttpr.onreadystatechange = handleServerResponse;
    			xmlhttpr.send("username="+username+"&password="+password);
    		}
    		else{
    			console.log("XMLHttpRequestObject not ready, trying again ...");
    			setTimeout('processLogin()', 1000);
    		}
    	}
    	
    	return false;
    }
    
    function handleServerResponse(){
    	var response = xmlhttpr.responseText;
    	if(response=="{success: true}"){
    		console.log("successfull login");
    		document.getElementById('username').style.visibility = 'hidden';
    		document.getElementById('password').style.visibility = 'hidden';
    		document.getElementById('labelusername').style.visibility = 'hidden';
    		document.getElementById('labelpassword').style.visibility = 'hidden';
    		document.getElementById('loginbutton').style.visibility = 'hidden';
    		document.getElementById('logininfo').innerHTML = "Login successfull";
    		
    		localStorage.setItem('username', username);
    		localStorage.setItem('password', password);	
    	}
    	else{
    		console.log(response);
    		document.getElementById('logininfo').innerHTML = "Login failed";
    	}
    }
    </script>
    
    <body onload="init()">
    <form onsubmit="return processLogin();">
    	<label id="labelusername" for="username">Username:
    		<input id="username" name="username">
    	</label>
    	<label id="labelpassword" for="password">Password:
    		<input id="password" name="password">
    	</label>
    	<input id="loginbutton" type="submit" value="Login" />
    	<br />
    	<h4 id="logininfo"></h4>
    </form>
    <br />
    
    <h2>Draw lines on the Canvas</h2>
        <canvas id="can" width="400" height="400" style="border:2px solid;"></canvas>
        
        
        
        <form method="get" action="./index.html">
    		<input type="submit" value="Back to Index" />
		</form>
		
		
    </body>
    </html>